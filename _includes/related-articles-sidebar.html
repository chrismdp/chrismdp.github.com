{% comment %}
Article sidebar - BBC-style layout with images, titles, and dates.
Used on both individual post pages (category-filtered) and the articles page (recent posts).

Parameters:
  include.limit  - number of articles to show (default: 5)
  include.title  - sidebar heading (default: "More to explore")
  include.mode   - "recent" to show recent posts, omit for category-based filtering
{% endcomment %}

{% assign sidebar_limit = include.limit | default: 5 %}
{% assign sidebar_offset = include.offset | default: 0 %}
{% comment %}Liquid's default filter treats "" as falsy, so we check explicitly to allow suppressing the heading{% endcomment %}
{% if include.title == "" %}
  {% assign sidebar_title = "" %}
{% else %}
  {% assign sidebar_title = include.title | default: "More to explore" %}
{% endif %}
{% assign sidebar_posts = "" | split: "" %}
{% assign now_time = site.time | date: "%s" | plus: 0 %}

{% if include.mode == "recent" %}
  {% assign skipped = 0 %}
  {% for post in site.posts %}
    {% assign post_time = post.date | date: "%s" | plus: 0 %}
    {% if post_time > now_time %}{% continue %}{% endif %}
    {% assign webinar_time = post.webinar_date | date: "%s" | plus: 0 %}
    {% if post.webinar_date and webinar_time > now_time %}{% continue %}{% endif %}
    {% if post.image %}
      {% if skipped < sidebar_offset %}
        {% assign skipped = skipped | plus: 1 %}
        {% continue %}
      {% endif %}
      {% assign sidebar_posts = sidebar_posts | push: post %}
      {% if sidebar_posts.size >= sidebar_limit %}{% break %}{% endif %}
    {% endif %}
  {% endfor %}
{% else %}
  {% assign seen_ids = "" %}
  {% assign oldest_date = page.date | date: "%s" | minus: 157680000 | date: "%Y-%m-%d" %}
  {% for tag in page.categories %}
    {% assign tag_posts = site.categories[tag] %}
    {% for post in tag_posts %}
      {% assign post_time = post.date | date: "%s" | plus: 0 %}
      {% if post_time > now_time %}{% continue %}{% endif %}
      {% assign webinar_time = post.webinar_date | date: "%s" | plus: 0 %}
      {% if post.webinar_date and webinar_time > now_time %}{% continue %}{% endif %}
      {% assign post_date = post.date | date: "%Y-%m-%d" %}
      {% if post.id != page.id and post_date >= oldest_date and post.image %}
        {% unless seen_ids contains post.id %}
          {% assign seen_ids = seen_ids | append: post.id | append: "," %}
          {% assign sidebar_posts = sidebar_posts | push: post %}
          {% if sidebar_posts.size >= sidebar_limit %}{% break %}{% endif %}
        {% endunless %}
      {% endif %}
    {% endfor %}
    {% if sidebar_posts.size >= sidebar_limit %}{% break %}{% endif %}
  {% endfor %}
{% endif %}

{% assign sidebar_count = sidebar_posts | size %}

{% if sidebar_count > 0 %}
<aside class="related-sidebar not-prose">
  {% if sidebar_title != "" %}<h3 class="text-xl font-heading font-bold mb-6 text-brand-black border-b-2 border-brand-deep-turquoise pb-2">{{ sidebar_title }}</h3>{% endif %}
  <div class="space-y-10">
    {% for post in sidebar_posts %}
      <article class="group">
        <a href="{{ site.baseurl }}{{ post.url }}" class="related-sidebar-link block" data-title="{{ post.title | escape }}">
          <img src="{{ post.image }}" alt="{{ post.title | escape }}" class="block w-3/5 mx-auto rounded-lg mb-2">
          <h4 class="font-heading font-semibold leading-snug text-brand-black group-hover:text-brand-deep-turquoise transition-colors">
            {{ post.title }}
          </h4>
          <div class="text-sm text-brand-black/50">
            {% assign original_date = post.path | split: "/" | last | split: "-" | slice: 0, 2 | join: '' %}
            {% assign current_date = post.date | date: "%Y%m" %}
            {% if original_date != current_date %}Updated {% endif %}
            {{ post.date | date: "%b %Y" }}
          </div>
        </a>
      </article>
    {% endfor %}
  </div>
</aside>
{% endif %}
