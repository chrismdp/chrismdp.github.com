{% comment %}
Related articles sidebar for A/B test variant.
BBC-style layout: text-only list with titles and dates.
Only includes posts that have images (for quality filtering).
{% endcomment %}

{% assign related_posts = "" %}
{% for tag in page.categories %}
  {% assign tag_posts = site.categories[tag] %}
  {% assign oldest_date = page.date | date: "%s" | minus: 157680000 | date: "%Y-%m-%d" %}

  {% for post in tag_posts %}
    {% assign post_time = post.date | date: "%s" | plus: 0 %}
    {% assign now_time = site.time | date: "%s" | plus: 0 %}
    {% if post_time > now_time %}{% continue %}{% endif %}
    {% assign post_date = post.date | date: "%Y-%m-%d" %}
    {% if post.id != page.id and post_date >= oldest_date and post.image %}
      {% assign related_posts = related_posts | append: post.id | append: "," %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% assign related_posts_array = related_posts | split: "," | uniq %}
{% assign related_posts_count = related_posts_array | size %}

{% if related_posts_count > 0 %}
<aside class="related-sidebar">
  <h3 class="text-xl font-heading font-bold mb-6 text-brand-black border-b-2 border-brand-deep-turquoise pb-2">More to explore</h3>
  <div class="space-y-10">
    {% for post_id in related_posts_array limit: 5 %}
      {% assign post = site.posts | where: "id", post_id | first %}
      <article class="group">
        <a href="{{ site.baseurl }}{{ post.url }}" class="related-sidebar-link block" data-title="{{ post.title | escape }}">
          <img src="{{ post.image }}" alt="{{ post.title | escape }}" class="w-3/5 mx-auto rounded-lg mb-2">
          <h4 class="font-heading font-semibold leading-snug text-brand-black group-hover:text-brand-deep-turquoise transition-colors">
            {{ post.title }}
          </h4>
          <div class="text-sm text-brand-black/50">
            {% assign original_date = post.path | split: "/" | last | split: "-" | slice: 0, 2 | join: '' %}
            {% assign current_date = post.date | date: "%Y%m" %}
            {% if original_date != current_date %}Updated {% endif %}
            {{ post.date | date: "%b %Y" }}
          </div>
        </a>
      </article>
    {% endfor %}
  </div>
</aside>
{% endif %}
