{% if page.series %}
{% assign all_series_posts = site.posts | where: "series", page.series | sort: "date" %}
{% assign series_posts = "" | split: "" %}
{% for post in all_series_posts %}
  {% assign post_time = post.date | date: "%s" | plus: 0 %}
  {% assign now_time = site.time | date: "%s" | plus: 0 %}
  {% if post_time <= now_time or post.url == page.url %}
    {% assign series_posts = series_posts | push: post %}
  {% endif %}
{% endfor %}
{% if series_posts.size > 1 %}
<aside class="series-sidebar mb-8 bg-brand-light-blue/10 rounded-lg p-5 border border-brand-light-blue/20">
  <p class="text-sm font-semibold text-brand-black mb-3">Part of the <strong>{{ page.series }}</strong> series:</p>
  <ul class="text-sm space-y-1.5">
    {% for post in series_posts %}
    <li>
      {% if post.url == page.url %}
        <div class="text-brand-black/60 font-medium">{{ post.title }} <span class="text-brand-black/40 italic">(this article)</span></div>
      {% else %}
        <a href="{{ post.url }}" class="series-link text-brand-deep-turquoise hover:text-brand-turquoise transition-colors block" data-series="{{ page.series }}" data-target-title="{{ post.title | escape }}">{{ post.title }}</a>
        <div class="text-brand-black/40 text-xs">{{ post.date | date: "%b %y" }}</div>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
</aside>
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (typeof posthog !== 'undefined') {
    posthog.onFeatureFlags(function() {
      var variant = posthog.getFeatureFlag('series-sidebar-experiment');
      if (variant === 'test') {
        document.querySelectorAll('.series-sidebar').forEach(function(el) {
          el.classList.remove('hidden');
        });
      }
      posthog.capture('series_page_viewed', {
        series: '{{ page.series }}',
        variant: variant || 'control'
      });
    });

    document.querySelectorAll('.series-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        posthog.capture('series_link_clicked', {
          series: this.dataset.series,
          target_title: this.dataset.targetTitle,
          source_url: window.location.pathname
        });
      });
    });
  }
});
</script>
{% endif %}
{% endif %}
